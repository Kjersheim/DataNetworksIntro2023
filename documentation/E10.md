# Documentation for E10

# IPv4 Network Address Translation

### Initial reflection
```
Going through the first materials on the subject discussing NAT. When being introduced with this, I immidiately was thinking that would it not just be as if the traffic was routed to the gateway/router, and that an interface on the router
was connected to the ISP subnet aka. connected to the open internet. Further on - why does it need to be translated? Does not the interface have its own address anyway? Could the router not store the information that each user
on my subnet was requesting through the router and the internet? 

On that note, I remembered an old issue dealing with ISP IP and phone logs. It is about 10 years since I first heard the term "NAT". Back at the time, we were already investigating various IP-addresses on a daily basis. By speaking to contacts within the ISPs, 
I was told that it was impossible to identify the user of a certain IP-address, due to the address being a NAT-address. When trying to get an explanation about this - seeing I had never had any experience with networking, I was told that due to the lack of IPv4 addresses, 
the ISP made the users share the same. This specially occured on mobile-devices at the time. The ISP/operator would have a server translating the addresses and having x amount of devices connected to it. When device x.1 wanted access to the internet, it gave the devices an address. 
Shortly after, device x.1 did no longer need access, but device x.2 did. The server switched the addresses so x.2 would now have the address x.1 had a short second ago. So within a few minutes, several devices would have used the same IP. 

If we imagine that the different devices x on the mobile basestation is the devices in our home network, each device will send information to the router, and the router would use the same address to reach outside our home network to the internet with the different sources in our home network. 

(On a sidenote: we did eventually realize that the ISP according to the laws in Norway also would need to have logs of this exchange of addresses and the subscribers, since they charged their subscribers money. So after discussing this with the ISP/Operator, we were often given
the logs and then tactically filtered the users of the IP based on other kinds of information)
```

## Plan

- [ ] Delete firewall configured in E09
- [ ] Configuring NAT
	- [ ] Visualize subnets to take account for in NAT
	- [ ] Configure Many-to-1
- [ ] Investigating traffic
	- [ ] CLI - commands
	- [ ] Wireshark


# Firewall removal

I go through my router 3 which was where the firewall was located. I remove all rulesets, and all policy-zones.

> delete firewall name LAN_to_WAN

Then repeating the above for all firewall names, LAN_to_vyos, vyos_to_LAN etc. After that I deleted all the zones.

> delete zone-policy zone LAN   (and WAN, then vyos)

- [x] Delete firewall configured in E09


# Configuring NAT

## Testing pre NAT

For the purpose of the exercise I clone the old Lubuntu Wireshark VM, calling the clone Lubuntu Wireshark 2. I position the Wireshark1 between Router A and C. I position Wireshark2 between Router C and LubuntuWAN.

I proceed to start a ping from Lubuntu 1 to Lubuntu WAN, and capture the packets on both sides of Router C. 

![](/documentation/E10/PingLub1toLubWANBEFORE.png)

As you see in the picture the source and destination is visible from both sides, marked with red and black squares in the picture. 



From the topology-charts I see that the interface on router C which will be handling outbound traffic is eth2:

>![](/documentation/E10/outboundinterface.png)

>![](/documentation/E10/settingoutboundinterface.png)

>![](/documentation/E10/outboundinterfacewireshark.png)

Already now, after masquerading the traffic, we see that the information that is being sent out is shown as 43.5.39.1 - which is interface eth2 on Router C - when in reality it is a ICMP request from Lubuntu1 (192.168.39.5).
When going deeper in the Wireshark readings, I notice that both the IP information about packets and the frame information is showing the ip and mac of the router C. Nowhere in the fields am I able to find any private addresses of my network. 

Since I deleted my firewall, I am now able to ping from Lubuntu WAN inside my LAN. I ping Lubuntu1 from WAN, and now I do see information about both original source and destination, as seen in the picture below.

>![](/documentation/E10/WAntoLubuntuBefore.png)

I perform the same tests between Lubuntu2 and Lubuntu WAN, with the same results. 

>At this point I am wondering the purpose of adding each subnet.. Then I do some more testing. While I add the subnet that contains Lubuntu1 to the NAT, I simultaneously do tests. Nothing has changed when I ping from Lubuntu1 to Lubuntu WAN. 

> **However** at this point I also keep pinging between Lubuntu2 and Lubuntu WAN, after adding the subnet of Lubuntu1 to the NAT. At this point suddenly I start seeing the source directly back to Lubuntu2!




