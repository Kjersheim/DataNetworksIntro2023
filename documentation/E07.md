# Documentation for E07

The functionality of a switch is to learn about their surroundings. When the switch receive an ethernet frame, and build up their forwarding table - "MAC-address table, -show fdb", they start to forward traffic in an ethernet network. 
If a switch do not have a destination MAC-address, an unknown address that is not in the FDB, the switch will spam out unknown MAC-addresses. "Unknown dstMAC frames" out of all ports. 

Within a RING topology, this is bad if there is no loop-detection, and it will form an infinite repetition loop. **Ethernet frames do not have TTL-field.**

```
Following the thread on this one to elaborate.

Historically it seems that a TTL-field on the ethernet frames were not, thought of or needed when they were introduced due to the limited complexities within networks, before switches and such were invented. 
Why not add it in later on? From what I have gained, a TTL-field would in the end just stop the one frame, and not fix an underlying issue of looping frames. 

From what I understand, if a host is caught in a loop, it is unaccessible from other hosts on the network. A "broadcast storm" can occur when there are so many frames in a loop that all avaliable bandwidth
is consumed. A TTL value would still have the frame run a loop, just not indefinitely, but long enough to cause problems? Can it be compared to a denial of service attack? 
In such a broadcast storm the forwarding tables are constantly updated with MAC-addresses, and even though the packet finally arrives at the correct destination it seems the tables are constantly faulty updated so the answer wont
be sent to the right recipient.

In the end, would not a TTL-field atleast help? But perhabs its still too little help to fix the issue. There will always be loops in a network which have been designed to avoid a single point of failure, 
and have multiple "roads". when this redundancy is introduced, loops and duplicate frames occur.  Despite the questions of TTL, this is the reason why The Spanning Tree Protocol was created, and from what I can see before entering
the materials is that it fixes the issues and TTL is out of the question. 

```




# Spanning Tree Protocol


## Plan

- [ ] Update and review current topology
	- [ ] Add Network_Switch_C to the topology, RING-topology
	- [ ] Move Lubuntu2 machine behind Network_Switch_C
	- [ ] Update adapters VirtualBox
	
- [ ] Configuration, update VLAN
	- [ ] Switch A
	- [ ] Switch B
	- [ ] Switch C

- [ ] Loop

- [ ] Spanning Tree Protocol
	- [ ] Update topology schematic
	- [ ] Enable on all 3 Switches
	- [ ] Investigate port states
	- [ ] Testing
	
# Update and review current topology

First steps is to clone a switch and add it to the schematic, set as a RING with the other switches. Then moving Lubuntu2 behind the new switch. 


## Draft of physical topology changes


![](/documentation/E07/E07NetworkCharts-Physical_Topology_draft3.png)

## Updating adapters

After drafting the physical changes, I start checking the adapters in VirtualBox, to make sure the "cables and interfaces" are correct. 

![](/documentation/E07/AdaptersSwitchA.png)
![](/documentation/E07/AdaptersSwitchB.png)

![](/documentation/E07/AdaptersSwitchC.png)


- [x] Update and review current topology
	- [x] Add Network_Switch_C to the topology, RING-topology
	- [x] Move Lubuntu2 machine behind Network_Switch_C
	- [x] Update adapters VirtualBox


## Updating VLAN & tagging ports

![](/documentation/E07/SwitchAtagging1.png)

- [x] Switch A
	
![](/documentation/E07/SwitchBtagging.png)

- [x] Switch B
	
![](/documentation/E07/SwitchCtagging.png)

In addition to this, adding a new ip-address and a gateway to Switch C.

![](/documentation/E07/SwitchCIpAndGateway.png)

- [x] Switch C
- [x] Configuration, update VLAN

# Connectivity tests pre-STP

## Switch A and B online, Switch C offline

Powering up all 3 Lubuntus, both routers and the abovementioned Switch A and B. 

Initially I ping Lubuntu3 from Lubuntu1:

![](/documentation/E07/PingL1L3.png)

Then I ping various devices from Lubuntu3:

![](/documentation/E07/L3Ping_1.png)

Seeing that Network_Switch_C is offline, any response from Lubuntu2 is not going to happend, as Lubuntu2 is only connected to Network_Switch_C.


## Switch B and C online, Switch A offline

Shutting down Switch A, powering up Switch C. 

Lubuntu3 to Lubuntu2:

![](/documentation/E07/PingL3L2.png)

Lubuntu 2 to different parts of the topology:

![](/documentation/E07/L2Ping_1_1.png)


# Creating a loop

I start of by closing down all switches, keeping routers and lubuntus online. I then proceed in making the lubuntus ping eachother, each Lubuntu marked with a red square around its number. 

![](/documentation/E07/RunningLubuntusAndRouters.png)

Having all 3 Lubuntus pinging eachother, but no switches being online - none will reach. In the next figure I start Network_Switch_A. 

I proceed starting Network_Switch_A and Network_Switch_B, monitoring the gpu as well as checking port status on the switches once they are online. 

After Switch A is up, there is still no connectivity as the other lubuntus need atleast one of the other switches to be online aswell. 

Booting up Switch B, and connection between Lubuntu3 and Lubuntu1 is visible in the picture below. Lubuntu2 is still behind Switch C. 
For some reason Lubuntu1 is not reaching Lubuntu3, but it does work the other way around. Cancelling the ping and restarting it fixes the problem. 

![](/documentation/E07/StartingSwitchB.png)

### Starting Network_Switch_C
Starting up the third Switch, completing the connection of the RING, visualized in the following **GIF**.
Immidiately I see that the processor is hitting the roof. Lubuntu2 Also suddenly get response from Lubuntu3, but it is very slow to update on the screen. 
In addition Lubuntu3 sees a hop in response "latency". 

![](/documentation/E07/StartingSwitchC.gif)

### Shutting down Network_Switch_C
And finally when shutting down Switch C, the processes drop immidiately, as shown in the **GIF** below. 

![](/documentation/E07/ShuttingDownSwitchC.gif)


# Spanning Tree Protocol 

## Configuring switches

Staring with Network_Switch_B as root, then A as backup root and lastly also adding STP to all VLANS and enabling it on Switch C. 

**Switch B:**

![](/documentation/E07/STPswitchB.png)

**Switch A:**

![](/documentation/E07/STPswitchA.png)

**Switch C:**

![](/documentation/E07/STPswitchC.png)



At the end of this, I start up Switch A and B, so all 3 are online. 

![](/documentation/E07/BootingUpRemainingSwitches.png)

As can be seen in the **GIF** below, the Lubuntus are now able to communicate and it seems the looping is under control!

![](/documentation/E07/AllSwitchesSTP.gif)


- [ ] Spanning Tree Protocol
	- [ ] Update topology schematic
	- [x] Enable on all 3 Switches
	- [ ] Investigate port states
	- [x] Testing
	
	
	
	
	
**Network_Switch_B**

```	
------------------------
SwitchB.1 # show stpd s0 
------------------------
Stpd: s0                Stp: ENABLED            Number of Ports: 3
Rapid Root Failover: Disabled
Operational Mode: MSTP                  Default Binding Mode: 802.1D
MSTI Instance:  CIST
802.1Q Tag: (none)
Ports: 1,2,3
Participating Vlans: network_devices,secretbasement,workstations
Auto-bind Vlans: Default
Bridge Priority            : 4096               Bridge Priority Mode: 802.1t
Operational Bridge Priority: 4096
BridgeID                   : 10:00:08:00:27:02:cc:fa
Designated root            : 10:00:08:00:27:02:cc:fa
CIST Root                  : 10:00:08:00:27:02:cc:fa
CIST Regional Root         : 10:00:08:00:27:02:cc:fa
External RootPathCost      : 0  Internal RootPathCost: 0 
Root Port   : ----      
MaxAge      : 20s       HelloTime     : 2s      ForwardDelay     : 15s
CfgBrMaxAge : 20s       CfgBrHelloTime: 2s      CfgBrForwardDelay: 15s
RemainHopCount: 20      CfgMaxHopCount: 20
Topology Change Time           : 35s            Hold time        : 1s
Topology Change Detected       : FALSE          Topology Change  : FALSE
Number of Topology Changes     : 2
Time Since Last Topology Change: 725s
Topology Change initiated locally on Port 2
Topology Change last received on Port 1 from 08:00:27:8b:dd:b1
Backup Root               : Off         Backup Root Activated  : FALSE
Loop Protect Event Window : 180s        Loop Protect Threshold : 3
New Root Trap             : On          Topology Change Trap   : Off
Tx Hold Count             : 6
SwitchB.2 # 


------------------------------
SwitchB.2 # show stpd s0 ports 
------------------------------

Port     Mode   State      Cost  Flags     Priority Port ID Designated Bridge
1      802.1D FORWARDING 200000 eDap-m--I- 128      8001    10:00:08:00:27:02:cc:fa
2      802.1D FORWARDING 200000 eDap-m--I- 128      8002    10:00:08:00:27:02:cc:fa
3      802.1D FORWARDING 200000 eDappw--B- 128      8003    10:00:08:00:27:02:cc:fa

Total Ports: 3

 ------------------------- Flags: ----------------------------
1:                e=Enable, d=Disable
2: (Port role)    R=Root, D=Designated, A=Alternate, B=Backup, M=Master
3: (Config type)  b=broadcast, p=point-to-point, e=edge, a=auto
4: (Oper. type)   b=broadcast, p=point-to-point, e=edge
5:                p=proposing, a=agree
6: (partner mode) d = 802.1d, w = 802.1w, m = mstp
7:                i = edgeport inconsistency
8:                S = edgeport safe guard active
                  s = edgeport safe guard configured but inactive
8:                G = edgeport safe guard bpdu restrict active in 802.1w and mstp
                  g = edgeport safe guard bpdu restrict active in 802.1d
9:                B = Boundary, I = Internal
10:               r = restricted role, t = active role
SwitchB.3 # 

```

**Network_Switch_A**

```
Lubuntu-1: ssh admin@10.8.83.1
admin@10.8.83.1's password: 
ExtremeXOS
Copyright (C) 1996-2020 Extreme Networks. All rights reserved.
...
==============================================================================


Press the <tab> or '?' key at any time for completions.
Remember to save your configuration changes.

------------------------
SwitchA.1 # show stpd s0 
------------------------
Stpd: s0                Stp: ENABLED            Number of Ports: 3
Rapid Root Failover: Disabled
Operational Mode: MSTP                  Default Binding Mode: 802.1D
MSTI Instance:  CIST
802.1Q Tag: (none)
Ports: 1,2,3
Participating Vlans: network_devices,secretbasement,workstations
Auto-bind Vlans: Default
Bridge Priority            : 8192               Bridge Priority Mode: 802.1t
Operational Bridge Priority: 8192
BridgeID                   : 20:00:08:00:27:8b:dd:b1
Designated root            : 10:00:08:00:27:02:cc:fa
CIST Root                  : 10:00:08:00:27:02:cc:fa
CIST Regional Root         : 10:00:08:00:27:02:cc:fa
External RootPathCost      : 0  Internal RootPathCost: 200000 
Root Port   : 2         
MaxAge      : 20s       HelloTime     : 2s      ForwardDelay     : 15s
CfgBrMaxAge : 20s       CfgBrHelloTime: 2s      CfgBrForwardDelay: 15s
RemainHopCount: 19      CfgMaxHopCount: 20
Topology Change Time           : 35s            Hold time        : 1s
Topology Change Detected       : FALSE          Topology Change  : FALSE
Number of Topology Changes     : 3
Time Since Last Topology Change: 903s
Topology Change initiated locally on Port 3
Topology Change last received on Port 2 from 08:00:27:02:cc:fa
Backup Root               : Off         Backup Root Activated  : FALSE
Loop Protect Event Window : 180s        Loop Protect Threshold : 3
New Root Trap             : On          Topology Change Trap   : Off
Tx Hold Count             : 6
SwitchA.2 # show stpd s0 ports 
Port     Mode   State      Cost  Flags     Priority Port ID Designated Bridge
1      802.1D FORWARDING 200000 eDappw--B- 128      8001    20:00:08:00:27:8b:dd:b1
2      802.1D FORWARDING 200000 eRapam--I- 128      8002    10:00:08:00:27:02:cc:fa
3      802.1D FORWARDING 200000 eDap-m--I- 128      8003    20:00:08:00:27:8b:dd:b1

Total Ports: 3

 ------------------------- Flags: ----------------------------
1:                e=Enable, d=Disable
2: (Port role)    R=Root, D=Designated, A=Alternate, B=Backup, M=Master
3: (Config type)  b=broadcast, p=point-to-point, e=edge, a=auto
4: (Oper. type)   b=broadcast, p=point-to-point, e=edge
5:                p=proposing, a=agree
6: (partner mode) d = 802.1d, w = 802.1w, m = mstp
7:                i = edgeport inconsistency
8:                S = edgeport safe guard active
                  s = edgeport safe guard configured but inactive
8:                G = edgeport safe guard bpdu restrict active in 802.1w and mstp
                  g = edgeport safe guard bpdu restrict active in 802.1d
9:                B = Boundary, I = Internal
10:               r = restricted role, t = active role
SwitchA.3 # 
```


**Network_Switch_C**

```
------------------------
SwitchC.1 # show stpd s0 
------------------------
Stpd: s0                Stp: ENABLED            Number of Ports: 3
Rapid Root Failover: Disabled
Operational Mode: MSTP                  Default Binding Mode: 802.1D
MSTI Instance:  CIST
802.1Q Tag: (none)
Ports: 1,2,3
Participating Vlans: network_devices,secretbasement,workstations
Auto-bind Vlans: Default
Bridge Priority            : 32768              Bridge Priority Mode: 802.1t
Operational Bridge Priority: 32768
BridgeID                   : 80:00:08:00:27:94:2c:0b
Designated root            : 10:00:08:00:27:02:cc:fa
CIST Root                  : 10:00:08:00:27:02:cc:fa
CIST Regional Root         : 10:00:08:00:27:02:cc:fa
External RootPathCost      : 0  Internal RootPathCost: 200000 
Root Port   : 2         
MaxAge      : 20s       HelloTime     : 2s      ForwardDelay     : 15s
CfgBrMaxAge : 20s       CfgBrHelloTime: 2s      CfgBrForwardDelay: 15s
RemainHopCount: 19      CfgMaxHopCount: 20
Topology Change Time           : 35s            Hold time        : 1s
Topology Change Detected       : FALSE          Topology Change  : FALSE
Number of Topology Changes     : 2
Time Since Last Topology Change: 1029s
Topology Change initiated locally on Port none
Topology Change last received on Port 2 from 08:00:27:02:cc:fa
Backup Root               : Off         Backup Root Activated  : FALSE
Loop Protect Event Window : 180s        Loop Protect Threshold : 3
New Root Trap             : On          Topology Change Trap   : Off
Tx Hold Count             : 6
------------------------
SwitchC.2 # show stpd s0 ports 
------------------------
Port     Mode   State      Cost  Flags     Priority Port ID Designated Bridge
1      802.1D BLOCKING   200000 eAapam--I- 128      8001    20:00:08:00:27:8b:dd:b1
2      802.1D FORWARDING 200000 eRapam--I- 128      8002    10:00:08:00:27:02:cc:fa
3      802.1D FORWARDING 200000 eDap-w--B- 128      8003    80:00:08:00:27:94:2c:0b

Total Ports: 3

 ------------------------- Flags: ----------------------------
1:                e=Enable, d=Disable
2: (Port role)    R=Root, D=Designated, A=Alternate, B=Backup, M=Master
3: (Config type)  b=broadcast, p=point-to-point, e=edge, a=auto
4: (Oper. type)   b=broadcast, p=point-to-point, e=edge
5:                p=proposing, a=agree
6: (partner mode) d = 802.1d, w = 802.1w, m = mstp
7:                i = edgeport inconsistency
8:                S = edgeport safe guard active
                  s = edgeport safe guard configured but inactive
8:                G = edgeport safe guard bpdu restrict active in 802.1w and mstp
                  g = edgeport safe guard bpdu restrict active in 802.1d
9:                B = Boundary, I = Internal
10:               r = restricted role, t = active role
SwitchC.3 # 


```




- [ ] Spanning Tree Protocol
	- [ ] Create topology for STP view
	- [x] Enable on all 3 Switches
	- [x] Investigate port states
	- [x] Testing